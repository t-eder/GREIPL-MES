<!DOCTYPE html>
<html>
<head>
    <title>GREIPL-MES</title>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/style.css') }}">


    <style>
        /* Styling für das Modal */
        #modal {
            display: none; /* Verstecke das Modal standardmäßig */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #modalContent {
            position: relative;
            margin: 10% auto;
            padding: 20px;
            background: #fff;
            border-radius: 5px;
            width: 300px;
        }

        #closeModalBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }

        label {
            display: block;
            margin: 10px 0 5px;
        }

        select, input[type="checkbox"], button {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }

        button {
            cursor: pointer;
        }

        .checkbox-container {
            display: flex;
            align-items: center;  /* Vertikal zentrieren */
            gap: 8px;  /* Abstand zwischen Checkbox und Label */
            margin-left: 8px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 16px;  /* Standardgröße */
            height: 16px;
            margin: 0;  /* Keine unnötigen Abstände */
            cursor: pointer;
        }

        .checkbox-container label {
            display: flex;
            align-items: center;  /* Icon & Text vertikal zentrieren */
            gap: 5px;  /* Abstand zwischen Icon und Text */
        }

        .checkbox-container img {
            height: 24px;  /* Größe des Icons */
        }

        .filter-container {
            display: flex;
            margin-bottom: 5px;  /* Abstand zur Tabelle */
            font-weight: bold;
        }

        .filter-container label {
            display: flex;
            align-items: center;
        }

        #filter-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(11, 41, 69, 0.9); /* Dunkles Blau mit Transparenz */
        color: white;
        padding: 5px 15px;  /* Weniger Innenabstand */
        display: flex;
        justify-content: center;
        gap: 15px;
        font-size: 14px; /* Etwas kleinere Schrift */
        font-weight: bold;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
        height: 35px; /* Fixierte Höhe für eine schmale Leiste */
        align-items: center; /* Elemente vertikal zentrieren */
        white-space: nowrap; /* Verhindert den Zeilenumbruch */
    }

    #filter-bar label {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #filter-bar input[type="checkbox"] {
        transform: scale(1.1); /* Leicht größere Checkbox */
        cursor: pointer;
    }

    #filter-bar button {
        background-color: #1a60a1; /* Blauen Hintergrund für den Button */
        color: white;
        border: none;
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 5px;
        height: 30px; /* Gleiche Höhe wie die anderen Elemente */
        width: 100px;
        margin: 10px;
    }

    #filter-bar button:hover {
        background-color: #0082da;; /* Dunklerer Grünton bei Hover */
    }
    </style>

</head>
<body>
{% include 'header.html' %}
<div class="container">

        <h1>Auftragsbestand</h1>
            <span ><b style="color: #A0A0A0">&#9646</b></span><span>10</span>
            <span ><b style="color: #a4e2eb">&#9646</b></span><span>20</span>
            <span ><b style="color: #60A5FA">&#9646</b></span><span>30</span>
            <span ><b style="color: #fcd703">&#9646</b></span><span>40</span>
            <span ><b style="color: #FB923C">&#9646</b></span><span>50</span>
            <span ><b style="color: #00b542">&#9646</b></span><span>60</span>
            <table class="table1">
                <thead style="position: sticky; top: 0; z-index: 2;">
                    <tr>
                        <th></th>
                        <th>STAT</th>
                        <th>FA</th>
                        <th>GREIPL-Nr</th>
                        <th>Bezeichnung</th>
                        <th>Menge</th>
                        <th>Start</th>
                        <th>Ende</th>
                        <th>Produktionszeit</th>
                        <th>Bemerkung</th>
                    </tr>
                </thead>
                {% for (year, week), jobs in grouped_jobs.items() %}
                    <tr style=" background-color: #0b2945; color: white; height: 15px; font-weight:bold;">
                        <td style="text-align: left;" colspan="10">{{ year }}, KW: {{ week }}</td>
                    </tr>

                    {% for job in jobs %}
                        <tr class="job-row"
                            {% if job.Zustand == "60" %}
                                style="background-color: #cceddf; color: grey;"
                            {% endif %}>
                            <td
                            style="
                            {% if job.Zustand == '10' %}
                                border-left: 4px solid #A0A0A0;
                            {% elif job.Zustand == '20' %}
                                border-left: 4px solid #a4e2eb;
                            {% elif job.Zustand == '30' %}
                                border-left: 4px solid #60A5FA;
                            {% elif job.Zustand == '40' %}
                                border-left: 4px solid #fcd703;
                            {% elif job.Zustand == '50' %}
                                border-left: 4px solid #FB923C;
                            {% elif job.Zustand == '60' %}
                                border-left: 4px solid #00b542;
                            {% endif %}"
                            >
                                {% if job.Typ == 'Start' %}
                                    <img src="{{ url_for('static', filename='fa_start.png') }}" alt="Icon" height="30px" style="filter: invert(0%);">
                                {% elif job.Typ == 'Ende' %}
                                    <img src="{{ url_for('static', filename='fa_end.png') }}" alt="Icon" height="30px" style="filter: invert(0%);">
                                {% endif %}
                            </td>
                            <td>
                                {% for info in auftrag_info %}
                                    {% if info.fa_mat | int == 1 and info.fa_nr | int == job.Auftrag %}
                                        <img src="{{ url_for('static', filename='goods.png') }}" alt="Icon" height="30px" style="filter: invert(0%);">
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td>{{ job.Zustand }}</td>
                            <td class="auftrag-num" data-auftrag="{{ job.Auftrag }}">{{ job.Auftrag }}</td>
                            <td>{{ job.Teil }}</td>
                            <td>{{ job.Bez }}</td>
                            <td>{{ job.Mng }}</td>
                            <td>{{ job.Datum.strftime('%d.%m.%Y') }}</td>
                            <td>{{ (job.Zeit / 60) | round(1) }} h</td>
                            <td style="width: 300px; text-align:left; border: 1px solid #e0e0e0;">
                                {% for info in auftrag_info %}
                                    {% if info.fa_nr | int == job.Auftrag %}
                                        <span class="data-comment" data-comment="{{ info.fa_bemerk }}"> {{ info.fa_bemerk }}</span>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </table>

<div id="filter-bar">
    <label>
        <input type="checkbox" id="hideStatus10"> Status 10 ausblenden
    </label>
    <label>
        <input type="checkbox" id="hideStatus60"> Status 60 ausblenden
    </label>
    <label>
    <input type="checkbox" id="showOnlyStart"> Nur Start-Zeilen
    </label>
    <label>
        <input type="checkbox" id="showOnlyEnd"> Nur End-Zeilen
    </label>
    <button id="jumpToCurrentWeek">Aktuelle KW</button>
</div>



<!-- Modal -->
<div id="modal" class="modal">
    <div id="modalContent" class="modal-content">
        <span id="closeModalBtn" class="close-btn">✖</span>

        <label for="comment">Kommentar eingeben:</label>
        <input type="text" id="comment" class="input-field" style="width:260px;">
        <br> <br>
        <div class="checkbox-container">
            <input type="checkbox" id="checkbox">
            <label for="checkbox"><img src="{{ url_for('static', filename='goods.png') }}" alt="Icon" height="30px" style="filter: invert(0%);"> Material komplett</label>
        </div>

        <br>
        <div class="button-container">
            <button id="saveBtn">Speichern</button>
            <button id="cancelBtn">Abbrechen</button>
        </div>
    </div>
</div>

        <p style="font-size:8px; float: right; color: lightgrey">Tobias Eder 2023</p>
    </div>

</body>
</html>

<script>
// Original Styles und HTML der Zellen mit Icons sichern
document.querySelectorAll('.job-row').forEach(row => {
    row.dataset.originalBgColor = row.style.backgroundColor || '';
    row.dataset.originalTextColor = row.style.color || '';
    row.dataset.originalFontWeight = row.style.fontWeight || '';

    // Icons-HTML sichern, z.B. im Auftrag-Cell
    const auftragCell = row.querySelector('.auftrag-num');
    if (auftragCell) {
        auftragCell.dataset.originalHtml = auftragCell.innerHTML;
    }
});

document.querySelectorAll('.auftrag-num').forEach(function (cell) {
    cell.addEventListener('click', function () {
        const clickedRow = cell.closest('tr');
        const clickedAuftrag = cell.getAttribute('data-auftrag');
        const isStart = clickedRow.querySelector('img[src*="fa_start.png"]');
        if (!isStart) return;

        // Alles zurücksetzen (inklusive Icons)
        resetAll();

        let currentRow = clickedRow;
        let foundStart = false;

        while (currentRow) {
            if (!currentRow.classList.contains('job-row')) {
                currentRow = currentRow.nextElementSibling;
                continue;
            }

            const rowAuftragCell = currentRow.querySelector('.auftrag-num');
            const rowAuftrag = rowAuftragCell?.getAttribute('data-auftrag') || '';
            const hasStartImg = currentRow.querySelector('img[src*="fa_start.png"]');
            const hasEndImg = currentRow.querySelector('img[src*="fa_end.png"]');

            // Start-Zeile färben
            if (hasStartImg && rowAuftrag === clickedAuftrag) {
                currentRow.style.backgroundColor = '#21cf15';
                currentRow.style.color = 'black';
                currentRow.style.fontWeight = 'bold';
                foundStart = true;
            }
            // End-Zeile färben
            else if (hasEndImg && rowAuftrag === clickedAuftrag && foundStart) {
                currentRow.style.backgroundColor = '#f56822';
                currentRow.style.color = 'black';
                currentRow.style.fontWeight = 'bold';
                break;
            }
            // Zwischenzeilen grau + dunkelgraue Schrift + Icons entfernen
            else if (foundStart && rowAuftrag !== clickedAuftrag) {
                currentRow.style.backgroundColor = '#d4d4d4'; // Grau
                currentRow.style.color = '#444';             // Dunkelgrau
                currentRow.style.fontWeight = 'normal';

                // Icons aus Auftrag-Zelle entfernen
                if (rowAuftragCell) {
                    rowAuftragCell.querySelectorAll('img[src*="fa_start.png"], img[src*="fa_end.png"]').forEach(img => img.remove());
                }
            }

            currentRow = currentRow.nextElementSibling;
        }
    });
});

// Funktion zum Zurücksetzen aller Styles und Icons
function resetAll() {
    document.querySelectorAll('.job-row').forEach(row => {
        row.style.backgroundColor = row.dataset.originalBgColor || '';
        row.style.color = row.dataset.originalTextColor || '';
        row.style.fontWeight = row.dataset.originalFontWeight || '';

        // Icons in Auftrag-Zelle wiederherstellen
        const auftragCell = row.querySelector('.auftrag-num');
        if (auftragCell && auftragCell.dataset.originalHtml) {
            auftragCell.innerHTML = auftragCell.dataset.originalHtml;
        }
    });
}

// ESC zum Zurücksetzen
document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape') {
        resetAll();
    }
});
</script>















<script>
    // Doppelklick-Eventlistener auf alle Elemente mit der Klasse 'auftrag-num'
    document.querySelectorAll('.auftrag-num').forEach(function (cell) {
        cell.addEventListener('dblclick', function () {
            const fa_nr = cell.getAttribute('data-auftrag');
            const row = cell.closest('tr');
            const commentCell = row.querySelector('.data-comment');
            const currentComment = commentCell ? commentCell.getAttribute('data-comment') : "";

            // Prüfen, ob das Material-Icon vorhanden ist
            const imgs = row.querySelectorAll('img');
            let hasMaterialIcon = false;
            imgs.forEach(img => {
                if (img.src.includes('goods.png') && img.style.filter === 'invert(0%)') {
                    hasMaterialIcon = true;
                }
            });

            // Öffne das Modal und setze Kommentar + Checkbox
            document.getElementById('modal').style.display = 'block';
            document.getElementById('comment').value = currentComment;
            document.getElementById('checkbox').checked = hasMaterialIcon;

            // Bestehende Listener entfernen durch Cloning
            const oldSaveBtn = document.getElementById('saveBtn');
            const newSaveBtn = oldSaveBtn.cloneNode(true);
            oldSaveBtn.parentNode.replaceChild(newSaveBtn, oldSaveBtn);

            const oldCancelBtn = document.getElementById('cancelBtn');
            const newCancelBtn = oldCancelBtn.cloneNode(true);
            oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);

            // Speichern-Button-Logik
            newSaveBtn.addEventListener('click', function () {
                const enteredComment = document.getElementById('comment').value;
                const checkboxChecked = document.getElementById('checkbox').checked;

                // 🧠 Filterzustände vor Reload speichern
                localStorage.setItem('filter_hideStatus10', document.getElementById('hideStatus10').checked);
                localStorage.setItem('filter_hideStatus60', document.getElementById('hideStatus60').checked);
                localStorage.setItem('filter_showOnlyStart', document.getElementById('showOnlyStart').checked);
                localStorage.setItem('filter_showOnlyEnd', document.getElementById('showOnlyEnd').checked);

                // AJAX-POST an Flask
                fetch('/update_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fa_nr: fa_nr,
                        comment: enteredComment,
                        fa_mat: checkboxChecked ? 1 : 0
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload(); // Seite neu laden, Filter wird danach rekonstruiert
                        } else {
                            alert("Fehler beim Aktualisieren.");
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

                document.getElementById('modal').style.display = 'none';
            });

            // Abbrechen
            newCancelBtn.addEventListener('click', function () {
                document.getElementById('modal').style.display = 'none';
            });
        });
    });

    // Modal schließen per X-Button
    document.getElementById('closeModalBtn').addEventListener('click', function () {
        document.getElementById('modal').style.display = 'none';
    });
</script>



<script>
function applyFilters() {
    const hide60 = document.getElementById('hideStatus60').checked;
    const hide10 = document.getElementById('hideStatus10').checked;
    const showOnlyStart = document.getElementById('showOnlyStart').checked;
    const showOnlyEnd = document.getElementById('showOnlyEnd').checked;

    document.querySelectorAll('.job-row').forEach(row => {
        const statusCell = row.querySelector('td:nth-child(3)');
        const typeImg = row.querySelector('td img');
        let shouldHide = false;

        // Status-Filter
        if (statusCell) {
            const status = statusCell.textContent.trim();
            if ((hide60 && status === '60') || (hide10 && status === '10')) {
                shouldHide = true;
            }
        }

        // Typ-Filter: prüft das 'fa_start.png' oder 'fa_end.png' im <img>-Tag
        if (showOnlyStart && (!typeImg || !typeImg.src.includes('fa_start.png'))) {
            shouldHide = true;
        }

        if (showOnlyEnd && (!typeImg || !typeImg.src.includes('fa_end.png'))) {
            shouldHide = true;
        }

        row.style.display = shouldHide ? 'none' : '';
    });
}

// Event Listener
document.getElementById('hideStatus60').addEventListener('change', applyFilters);
document.getElementById('hideStatus10').addEventListener('change', applyFilters);
document.getElementById('showOnlyStart').addEventListener('change', applyFilters);
document.getElementById('showOnlyEnd').addEventListener('change', applyFilters);
document.getElementById('applyFilters').addEventListener('click', applyFilters);
</script>


<script>
document.getElementById('jumpToCurrentWeek').addEventListener('click', function() {
    // Berechne die aktuelle Kalenderwoche
    const currentDate = new Date();
    const currentWeek = getWeekNumber(currentDate);

    // Suche die Zeile mit der entsprechenden Kalenderwoche
    const weekRows = document.querySelectorAll('tr');
    weekRows.forEach(row => {
        const weekCell = row.querySelector('td[colspan="10"]'); // Angenommen, die Kalenderwoche steht in einer speziellen Zelle
        if (weekCell && weekCell.textContent.includes('KW: ' + currentWeek)) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Scrolle zur Zeile der aktuellen KW
        }
    });
});

// Funktion zur Berechnung der Kalenderwoche
function getWeekNumber(date) {
    const startDate = new Date(date.getFullYear(), 0, 1);
    const days = Math.floor((date - startDate) / (24 * 60 * 60 * 1000));
    return Math.ceil((days + 1) / 7);
}
</script><!-- Zur aktuellen KW springen -->

<script>
    window.addEventListener('load', () => {
        // Zustand aus localStorage wiederherstellen
        const restore = (id, value) => {
            if (localStorage.getItem(value) !== null) {
                document.getElementById(id).checked = localStorage.getItem(value) === 'true';
            }
        };

        restore('hideStatus10', 'filter_hideStatus10');
        restore('hideStatus60', 'filter_hideStatus60');
        restore('showOnlyStart', 'filter_showOnlyStart');
        restore('showOnlyEnd', 'filter_showOnlyEnd');

        // Filter anwenden
        if (typeof applyFilters === 'function') {
            applyFilters();
        }

        // Optional: Speicher löschen (wenn du möchtest, dass es nur für einen Reload gilt)
        // localStorage.removeItem('filter_hideStatus10');
        // localStorage.removeItem('filter_hideStatus60');
        // localStorage.removeItem('filter_showOnlyStart');
        // localStorage.removeItem('filter_showOnlyEnd');
    });
</script>
